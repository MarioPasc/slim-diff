# ICIP 2026 Similarity Metrics Configuration
#
# Default configuration for computing KID, FID, and LPIPS metrics
# across the multi-axis ablation study experiments.
#
# Usage:
#   jsddpm-similarity-metrics compute-all --config config/icip2026.yaml
#
# CLI arguments override these settings.

# =============================================================================
# Ablation Study Configuration
# =============================================================================
# Defines the multi-axis parameter space for experiment discovery.
# Experiments are discovered automatically from hierarchical folder structure:
#   {runs_dir}/self_cond_p{X}/{pred_type}_lp_{Y}/replicas/
ablation:
  axes:
    self_cond_p:
      values: [0.0]  # Fixed at 0.0 for this analysis
      display_format: "{:.1f}"
      folder_format: "self_cond_p_{value}"
    prediction_type:
      values: ["epsilon", "velocity", "x0"]
      display_format: "{}"
      folder_format: "{value}"
    lp_norm:
      values: [1.5, 2.0, 2.5]
      display_format: "{:.1f}"
      folder_format: "lp_{value}"

  hierarchy: ["self_cond_p", "prediction_type_lp_norm"]
  default_self_cond_p: 0.0

  # Filter experiments to process (empty = all discovered experiments)
  # Fixed self_cond_p=0.0, sweeping prediction_type Ã— lp_norm (9 configurations)
  include:
    - self_cond_p: 0.0

# =============================================================================
# Cross-Experiment Comparison Configuration
# =============================================================================
comparison:
  analyses:
    - name: "by_prediction_type"
      varying_axis: "prediction_type"
      fixed_axes: {}
    - name: "by_lp_norm"
      varying_axis: "lp_norm"
      fixed_axes: {}
    # self_cond_p analyses removed (fixed at 0.0)

# =============================================================================
# Path Configuration
# =============================================================================
paths:
  # Directory containing experiment folders in hierarchical structure
  # Structure: {runs_dir}/self_cond_p{X}/{pred_type}_lp_{Y}/replicas/
  runs_dir: /media/mpascual/Sandisk2TB/research/jsddpm/results/epilepsy/icip2026/runs/self_cond_ablation

  # Directory containing cached slices with train.csv, val.csv, test.csv
  cache_dir: /media/mpascual/Sandisk2TB/research/jsddpm/data/epilepsy/slice_cache

  # Output directory for results (CSVs, plots, reports)
  # output_dir/similairity_metrics/
  # outpit_dir/mask_metrics/
  output_dir: /media/mpascual/Sandisk2TB/research/jsddpm/results/epilepsy/icip2026/similarity_metrics/self_cond_p_0.0

# =============================================================================
# Experiment Configuration (legacy - preserved for backward compatibility)
# =============================================================================
experiments:
  # These settings are now superseded by the ablation section above
  # Prediction types to include (auto-discovered from ablation.axes)
  prediction_types:
    - epsilon
    - velocity
    - x0

  # Lp norm values (auto-discovered from ablation.axes)
  lp_norms:
    - 1.5
    - 2.0
    - 2.5

  # Number of replicas per experiment
  n_replicas: 5

  # Valid z-bins to include (default: 0-29)
  valid_zbins: null  # null = use all 30 bins

# =============================================================================
# Metric Configuration
# =============================================================================
metrics:
  kid:
    enabled: true
    # Subset size for KID computation (smaller = faster, less stable)
    subset_size: 1000
    # Number of subsets for KID statistics
    num_subsets: 100
    # Polynomial kernel degree
    degree: 3
    # Compute per-zbin KID (uses merged replicas)
    per_zbin: true
    # Smaller subset size for per-zbin (fewer samples per bin)
    per_zbin_subset_size: 250
    per_zbin_num_subsets: 50

  fid:
    enabled: true
    # FID only computed globally (not per-zbin) due to sample size requirements
    per_zbin: false

  lpips:
    enabled: true
    # Network backbone: "vgg" (default) or "alex"
    net: vgg
    # Number of random pairs for LPIPS computation
    n_pairs: 1000
    # Compute per-zbin LPIPS
    per_zbin: true
    # Pairs per z-bin (fewer available samples per bin)
    n_pairs_per_zbin: 100

  # Mask morphology distance (MMD-MF) - evaluates generated mask quality
  # Computes MMD on morphological features (area, circularity, solidity, etc.)
  mask_morphology:
    enabled: true
    # Minimum lesion size to include (pixels)
    min_lesion_size_px: 5
    # Features to extract (null = all 9 features)
    # Options: area, perimeter, circularity, solidity, extent, eccentricity,
    #          major_axis_length, minor_axis_length, equivalent_diameter
    features: null
    # MMD subset size (number of lesions per subset)
    subset_size: 500
    # Number of subsets for variance estimation
    num_subsets: 100
    # Polynomial kernel degree
    degree: 3
    # Z-score normalize features before MMD
    normalize_features: true
    # Compute per-feature Wasserstein distances for diagnostic breakdown
    compute_wasserstein: true
    # Per-zbin computation (uses smaller subsets)
    per_zbin: false
    per_zbin_subset_size: 200
    per_zbin_num_subsets: 50

# =============================================================================
# Compute Configuration
# =============================================================================
compute:
  # CUDA device (use "cpu" for CPU-only computation)
  device: "cuda:1"

  # Batch size for feature extraction
  # Reduce if running out of GPU memory
  batch_size: 32

  # Number of replicas to merge for per-zbin computation
  # 5 = merge all replicas for maximum stability
  merge_replicas_for_zbin: 5

  # Random seed for reproducibility
  seed: 42

# =============================================================================
# Statistical Analysis Configuration
# =============================================================================
statistics:
  # Significance level for hypothesis tests
  alpha: 0.05

  # Multiple comparison correction method
  # Options: "fdr_bh" (Benjamini-Hochberg), "bonferroni", "holm"
  correction_method: fdr_bh

  # Tests to run
  tests:
    # Within-group: Compare Lp norms within each prediction type
    within_group:
      enabled: true
      test: friedman  # Non-parametric repeated measures
      posthoc: nemenyi

    # Between-group: Compare prediction types
    between_group:
      enabled: true
      test: kruskal_wallis  # Non-parametric one-way ANOVA
      posthoc: dunn

# =============================================================================
# Plotting Configuration
# =============================================================================
plotting:
  # Output formats for figures
  formats:
    - pdf
    - png

  # DPI for raster formats
  dpi: 300

  # IEEE publication style (uses scienceplots if available)
  style: ieee

  # Paul Tol colorblind-safe color scheme for prediction types
  # Reference: https://personal.sron.nl/~pault/
  colors:
    epsilon: "#EE7733"  # Paul Tol Bright Red
    velocity: "#009988"  # Paul Tol Bright Green
    x0: "#0077BB"       # Paul Tol Bright Blue 
    # '#EE7733', '#0077BB', '#33BBEE', '#EE3377', '#CC3311', '#009988', '#BBBBBB'

  # Line styles for Lp norms
  linestyles:
    1.5: "-"    # Solid
    2.0: "--"   # Dashed
    2.5: ":"    # Dotted

  # Markers for Lp norms
  markers:
    1.5: "o"    # Circle
    2.0: "s"    # Square
    2.5: "^"    # Triangle

  # Hatch patterns for boxplots (grayscale compatible)
  hatches:
    1.5: null   # Solid fill
    2.0: "//"   # Forward diagonal
    2.5: "\\\\"  # Backward diagonal

  # Alpha values for Lp norms (transparency gradient)
  alphas:
    1.5: 1.0
    2.0: 0.85
    2.5: 0.7

  # Show error bands on per-zbin plots
  show_error_bands: true

  # Show significance brackets on global plots
  show_significance: true

  # Show effect sizes (Cliff's delta) on significance brackets
  show_effect_sizes: true

  # Show individual data points on boxplots
  show_points: true

  # Highlight best configuration with star
  highlight_best: true

  # Boxplot settings
  boxplot:
    width_factor: 0.25  # Box width as fraction of group spacing
    whis: [5, 95]       # Whisker percentiles (5th to 95th)

  # Representative MRI images above per-zbin plots
  images:
    enabled: true
    step: 5        # Sample every Nth z-bin (~6 images for 30 bins)
    zoom: 0.18     # Zoom factor for images
    x_offset: 0.075  # Horizontal offset (fraction) - adjust to align images
    y_offset: -0.22 # Vertical offset above axis (fraction)

  # ICIP 2026 publication figure (2x2 layout for \begin{figure*})
  icip2026_figure:
    enabled: true
    # Metrics to include (kid, lpips - FID excluded as highly correlated with KID)
    metrics:
      - kid
      - lpips
    # Show per-subplot legends for Lp norms (if false, all in unified bottom legend)
    show_subplot_legends: false
    # Show brain images above LPIPS plot (in addition to KID plot)
    show_images_on_lpips: false
    # Number of columns in unified legend (8 = single row for figure*)
    legend_ncol: 8
    # Aspect ratio (height/width) - 0.55 for wider than tall (figure*)
    aspect_ratio: 0.55
