# Classification Task Configuration
# ==================================
# Master config for ICIP 2026 lesion quality assessment.
# Assesses whether synthetic lesions are distinguishable from real ones.

experiment:
  name: "icip2026_lesion_classification"
  seed: 42

# ---------------------------------------------------------------------------
# Ablation Study Configuration
# ---------------------------------------------------------------------------
# Defines the multi-axis parameter space for experiment discovery.
# Experiments are discovered automatically from hierarchical folder structure:
#   {results_base_dir}/self_cond_p{X}/{pred_type}_lp_{Y}/replicas/
ablation:
  axes:
    self_cond_p:
      values: [0.0, 0.5, 0.8]
      display_format: "{:.1f}"
      folder_format: "self_cond_p{value}"
    prediction_type:
      values: ["epsilon", "velocity", "x0"]
      display_format: "{}"
      folder_format: "{value}"
    lp_norm:
      values: [1.5, 2.0, 2.5]
      display_format: "{:.1f}"
      folder_format: "lp_{value}"

  # Folder hierarchy: outermost to innermost
  hierarchy: ["self_cond_p", "prediction_type_lp_norm"]

  # Default self_cond_p for legacy experiment names without it
  default_self_cond_p: 0.5

  # Filter which experiments to process (empty = all discovered experiments)
  # Examples:
  #   - {}  # All experiments
  #   - prediction_type: x0
  #   - self_cond_p: [0.5, 0.8]
  #   - prediction_type: x0
  #     lp_norm: 1.5
  include: []

# ---------------------------------------------------------------------------
# Data
# ---------------------------------------------------------------------------
data:
  # Real data (slice cache)
  real:
    cache_dir: "/media/mpascual/Sandisk2TB/research/jsddpm/data/epilepsy/slice_cache"
    csv_files: ["train.csv", "val.csv", "test.csv"]
    slices_subdir: "slices"

  # Synthetic data
  # Hierarchical structure: {results_base_dir}/self_cond_p{X}/{pred_type}_lp_{Y}/replicas/
  synthetic:
    results_base_dir: "/media/mpascual/Sandisk2TB/research/jsddpm/results/epilepsy/icip2026/runs/self_cond_ablation"
    replicas_subdir: "replicas"
    replica_ids: [0, 1, 2, 3, 4]

  # Patch extraction settings
  patch_extraction:
    method: "dynamic"         # "dynamic" computes size from max lesion bbox; "fixed" uses fixed_size
    padding: 8                # Padding around lesion bbox (pixels)
    min_patch_size: 32        # Minimum patch dimension
    max_patch_size: 96        # Maximum patch dimension
    fixed_size: 64            # Used when method="fixed"

  # Held-out test set (split before k-fold)
  test_split:
    fraction: 0.20          # 20% of data held out for testing
    stratify_by: "z_bin"    # Stratify test set by z-bin
    seed: 42

  # K-fold cross-validation (on remaining 80%)
  kfold:
    n_folds: 2
    stratify_by: "z_bin"
    seed: 42

  # Input modes to evaluate
  input_modes: ["joint"]  # , "image_only", "mask_only"
  # "joint":      2-channel (image + mask) — overall paired quality
  # "image_only": 1-channel (FLAIR patch) — texture quality
  # "mask_only":  1-channel (mask patch) — shape/boundary quality

# ---------------------------------------------------------------------------
# Model
# ---------------------------------------------------------------------------
model:
  # Path to model architecture YAML (relative to this file's directory)
  config_path: "models/simple_cnn.yaml"

# ---------------------------------------------------------------------------
# Training
# ---------------------------------------------------------------------------
training:
  batch_size: 8
  max_epochs: 50
  learning_rate: 1.0e-4
  weight_decay: 1.0e-5
  optimizer: "adam"

  scheduler:
    type: "reduce_on_plateau"
    factor: 0.5
    patience: 5
    min_lr: 1.0e-6

  early_stopping:
    monitor: "val/auc"
    mode: "max"
    patience: 3
    min_delta: 0.001

  precision: "32-true"
  num_workers: 4
  pin_memory: true

# ---------------------------------------------------------------------------
# Evaluation
# ---------------------------------------------------------------------------
evaluation:
  # Bootstrap confidence intervals
  bootstrap:
    n_iterations: 2000
    confidence_level: 0.95
    seed: 42

  # Permutation test for H0: AUC = 0.5
  permutation_test:
    n_permutations: 10000
    alpha: 0.05
    seed: 42

  # Per-z-bin analysis
  per_zbin:
    enabled: true
    min_samples: 10

  # Real-vs-real control experiment
  control:
    enabled: true
    n_repeats: 5

# ---------------------------------------------------------------------------
# Output
# ---------------------------------------------------------------------------
output:
  base_dir: "/media/mpascual/Sandisk2TB/research/jsddpm/results/epilepsy/icip2026/classification"
  patches_subdir: "patches"
  full_images_subdir: "full_images"
  results_subdir: "results"
  checkpoints_subdir: "checkpoints"
  figures_subdir: "figures"
  tables_subdir: "tables"
