# Diagnostics Configuration
# =========================
# Configuration for the real vs. synthetic diagnostic analysis pipeline.

# ---------------------------------------------------------------------------
# Ablation Study Configuration
# ---------------------------------------------------------------------------
# Defines the multi-axis parameter space for experiment discovery and comparison.
ablation:
  axes:
    self_cond_p:
      values: [0.0, 0.5, 0.8]
      display_format: "{:.1f}"
      folder_format: "self_cond_p{value}"
    prediction_type:
      values: ["epsilon", "velocity", "x0"]
      display_format: "{}"
      folder_format: "{value}"
    lp_norm:
      values: [1.5, 2.0, 2.5]
      display_format: "{:.1f}"
      folder_format: "lp_{value}"

  hierarchy: ["self_cond_p", "prediction_type_lp_norm"]
  default_self_cond_p: 0.5

# ---------------------------------------------------------------------------
# Cross-Experiment Comparison Configuration
# ---------------------------------------------------------------------------
# Defines which comparisons to generate in aggregate reports.
comparison:
  analyses:
    # Compare across prediction types (fix self_cond_p and lp_norm)
    - name: "by_prediction_type"
      varying_axis: "prediction_type"
      fixed_axes: {}

    # Compare across Lp norms (fix self_cond_p and prediction_type)
    - name: "by_lp_norm"
      varying_axis: "lp_norm"
      fixed_axes: {}

    # Compare across self-conditioning probabilities
    - name: "by_self_cond_p"
      varying_axis: "self_cond_p"
      fixed_axes: {}

    # Focused comparisons: x0 only, varying self_cond_p
    - name: "x0_self_cond_sweep"
      varying_axis: "self_cond_p"
      fixed_axes:
        prediction_type: "x0"

    # Focused comparisons: x0_lp_1.5, varying self_cond_p
    - name: "x0_lp1.5_self_cond_sweep"
      varying_axis: "self_cond_p"
      fixed_axes:
        prediction_type: "x0"
        lp_norm: 1.5

# ---------------------------------------------------------------------------
# Data Paths
# ---------------------------------------------------------------------------
data:
  patches_base_dir: "/media/mpascual/Sandisk2TB/research/jsddpm/results/epilepsy/icip2026/classification/patches"
  checkpoints_base_dir: "/media/mpascual/Sandisk2TB/research/jsddpm/results/epilepsy/icip2026/classification/checkpoints"
  classification_results_dir: "/media/mpascual/Sandisk2TB/research/jsddpm/results/epilepsy/icip2026/classification/results"
  replicas_base_dir: "/media/mpascual/Sandisk2TB/research/jsddpm/results/epilepsy/icip2026/runs/self_cond_ablation"
  real_cache_dir: "/media/mpascual/Sandisk2TB/research/jsddpm/data/epilepsy/slice_cache"
  full_image_replica_ids: [0, 1, 2, 3, 4]

dithering:
  seed: 42
  clip_range: [-1.0, 1.0]
  reclassification:
    n_folds: 2
    max_epochs: 50
    batch_size: 16
    learning_rate: 1.0e-4
    weight_decay: 1.0e-5
    early_stopping_patience: 10
    input_modes: ["joint"]
  metrics:
    bootstrap_n: 2000
    confidence_level: 0.95

gradcam:
  target_class: 1
  input_modes: ["joint"]
  batch_size: 16
  aggregation:
    per_zbin: true
    per_class: true
    radial_profile_bins: 20
    n_sample_visualizations: 16

feature_probes:
  spectral:
    channels: [0, 1]
    n_frequency_bands: 5
  texture:
    glcm_distances: [1, 2, 4]
    glcm_angles: [0.0, 0.7854, 1.5708, 2.3562]  # 0, pi/4, pi/2, 3pi/4
    glcm_levels: 64
    lbp_radii: [1, 2, 3]
    lbp_points: [8, 16, 24]
    gradient_n_bins: 100
  frequency_bands:
    n_bands: 5
    channels: [0, 1]

statistical:
  alpha: 0.05
  correction: "fdr_bh"
  channels: [0, 1]
  per_zbin: true
  distributions:
    n_bins: 200
    tissue_segmentation: true
    lesion_threshold: 0.3
    brain_threshold: -0.8
    background_threshold: -0.95
  boundary:
    n_radii: 15
    max_distance: 10
  wavelet:
    wavelet: "db4"
    levels: 4

full_image:
  background:
    threshold: -0.95
    noise_threshold: 0.01
  spatial_correlation:
    max_lag: 20
  global_frequency:
    channels: [0]

output:
  base_dir: "/media/mpascual/Sandisk2TB/research/jsddpm/results/epilepsy/icip2026/diagnostics"
  plot_format: ["png", "pdf"]
  plot_dpi: 300
  save_data: true

xai:
  channel_decomposition:
    ablation_baseline: -1.0  # Fill value when ablating a channel (-1 = background)
    per_layer: true  # Also compute per-layer channel contributions
  spectral_attribution:
    source: "gradcam"  # "gradcam" (uses pre-computed heatmaps) or "input_gradient"
    n_bands: 5  # Must match feature_probes.frequency_bands.n_bands
  feature_space:
    pca_components: 10
    tsne_perplexity: 30
    tsne_seed: 42
    top_features: 5  # Top-k discriminative features to visualize
  integrated_gradients:
    n_steps: 50
    baseline: "zeros"  # "zeros" or "noise"
    max_samples: 100  # Total samples (50 per class) for computational efficiency
  confusion_stratified:
    enabled: true
    use_full_images: true
    use_ensemble: true  # When using held-out test set, average predictions across folds
    n_representative_samples: 8  # Per category for detailed analysis
    comparisons:
      - ["FP", "TN"]  # Primary: what makes FP indistinguishable from real
      - ["FN", "TP"]  # Secondary: unusual real samples
    visualization:
      panel_dpi: 300
      panel_format: ["pdf", "png"]
      include_individual_samples: true
      n_samples_per_subplot: 4
      radial_profile_bins: 20

reporting:
  compact_format: "yaml"
  quality_thresholds:  # For letter grades in compact report
    A: 0.05
    B: 0.15
    C: 0.30
    D: 0.50
  recommendation_engine: true

experiment:
  seed: 42
  device: "cuda"
